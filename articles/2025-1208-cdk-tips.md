---
title: "[AWS] VPC周りの設定変更には気をつけようねを体感した話"
emoji: "🤔"
type: "tech"
topics: [AWS,CDK,VPC]
published: false
---

# はじめに

AWS CDKを使ってVPC周りの設定変更に苦戦したので、

## やりたかったこと

**マルチAZ構成に変更したい！**

「マネコンで操作する分には設定変更ページでポチポチできた(気がする)ので、CDKでも簡単にできるだろう。」
そう思っていました。イメージは`availabilityZones[]`の配列にazを増やして`cdk deploy`するだけ（または`maxAzs`を1→2へ）。
しかしそんな簡単な問題ではありませんでした。

![]("./img/cdk_1.png")

```
The CIDR 'xx.xx.xx.x/xx' conflicts with another subnet
```
と怒られたのです。内容はマルチAZにしようとしてサブネット作ろうとしたけど、すでにそのIP範囲は使っているから競合していると見ればなんとなくわかりますが、自分は納得ができませんでした。なぜこうなったかを詳細に説明していきます。

## aaaa
この時、下記のように実装していました

```typescript

```

L2コンストラクトを使ったシンプルなVPCの設定です。
さらにここに書いている、`ipAddresses`(CIDR)や、各サブネットマスクはSREチームに設計してもらった内容を反映しています。各サブネットに作成されるリソースを考慮して3AZまでならIPアドレスが枯渇することはないような設定です。その上で、「今マルチAZにするとお金もかかるし、その時が来たら増やせば良いだろう」そう思って最初は1AZで構築していました。