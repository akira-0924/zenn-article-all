---
title: "[AWS] CDKã§SSM ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã«å€¤ã‚’ã‚»ãƒƒãƒˆã™ã‚‹"
emoji: "ğŸ˜€"
type: "tech"
topics: [AWS,TypeScript,SSM,CDK]
published: false
---
## ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã¨ã¯
- AWS SSM ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã¯ã€AWSã®ã‚µãƒ¼ãƒ“ã‚¹ã®è¨­å®šå€¤ã‚„ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆå€¤ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ã™ã‚‹ç’°å¢ƒå¤‰æ•°ç­‰ã‚’å®‰å…¨ã«ä¿å­˜ã™ã‚‹ãŸã‚ã®ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚ã‚‹ã€‚
- éšå±¤å‹ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã§ã‚ã‚‹ã€‚

## CDKã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã«å€¤ã‚’ã‚»ãƒƒãƒˆã™ã‚‹
æ—©é€Ÿã€CDKã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã«å€¤ã‚’ã‚»ãƒƒãƒˆã—ã¦ã¿ã‚‹ã€‚
```typescript:environments-stack.ts

import { App, Stack, StackProps } from 'aws-cdk-lib'
import * as ssm from 'aws-cdk-lib/aws-ssm';

export class EnvironmentStack extends Stack {
  constructor(scope: App, id: string, props: StackProps) {
    super(scope, id, props);
    new ssm.StringParameter(this, 'parameter', {
      parameterName: '/example/EXAMPLE_KEY',
      stringValue: `dummy`,
    });
  }
}

```
`aws-cdk-lib/aws-ssm`ã‹ã‚‰`StringParameter`ã‚’importã—ã¦ãã¦ã€`parameterName`ï¼ˆã‚­ãƒ¼ï¼‰ã€`stringValue`ï¼ˆå€¤ï¼‰ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã«å€¤ãŒã‚»ãƒƒãƒˆã•ã‚Œã‚‹ã€‚
![ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ 2024-01-05 14.44.26.png](https://qiita-image-store.s3.ap-northeast-1.amazonaws.com/0/3655825/904b940a-4fd1-7c1e-702c-8c995f008a68.png)
ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ‡ãƒ¼ã‚¿å‹ã¯textã®Stringã«ãªã‚Šã¾ã™ï¼‰

### .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰èª­ã¿è¾¼ã‚€
ã“ã‚Œã¯CDKã®è©±ã§ã¯ãªã„æ°—ãŒã™ã‚‹ãŒã€`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã§ç’°å¢ƒå¤‰æ•°ã‚’ç®¡ç†ã—ã¦ãŠã‚Šã€ãã®å€¤ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚»ãƒƒãƒˆã™ã‚‹å ´åˆã¯ä»¥ä¸‹ã«ãªã‚‹ã€‚
```typescript:environments-stack.ts
import { App, Stack, StackProps } from 'aws-cdk-lib'
import * as ssm from 'aws-cdk-lib/aws-ssm';
import * as dotenv from 'dotenv'

export class EnvironmentStack extends Stack {
  constructor(scope: App, id: string, props: StackProps) {
    super(scope, id, props);
    dotenv.config();
    new ssm.StringParameter(this, 'parameter', {
      parameterName: '/example/EXAMPLE_KEY',
      stringValue: `${process.env.EXAMPLE_KEY}`,
    });
  }
}
```
```.env
EXAMPLE_KEY="dummy"
```

### ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‹ã‚‰å€¤ã‚’å–å¾—ã—ã¦ã‚»ãƒƒãƒˆã™ã‚‹
DBã®æ¥ç¶šæƒ…å ±ãªã©ã€SecretManagerã«ã‚ã‚‹å€¤ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã«ã‚»ãƒƒãƒˆã™ã‚‹å ´åˆã¯ã€ã¾ãšã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‹ã‚‰å€¤ã‚’å–å¾—ã—ã¦ãã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
```typescript:environments-stack.ts
import { App, Stack, StackProps } from 'aws-cdk-lib'
import * as ssm from 'aws-cdk-lib/aws-ssm';
import * as dotenv from 'dotenv'
import * as sm from 'aws-cdk-lib/aws-secretsmanager';

export class EnvironmentStack extends Stack {
  constructor(scope: App, id: string, props: StackProps) {
    super(scope, id, props);
    dotenv.config();
    //ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‹ã‚‰å€¤ã‚’å–å¾—
    const secretJson = sm.Secret.fromSecretAttributes(this, 'SecretStrings', {
      secretCompleteArn: "arn:aws:secretsmanager:ap-northeast-1:xxxxxxx:secret:xxxxxx-xxxx-xxxxx"
    });
    const secret_DB_NAME = secretJson.secretValueFromJson('dbname').unsafeUnwrap();
    const secret_DB_PASSWORD = secretJson.secretValueFromJson('password').unsafeUnwrap();
    const secret_DB_USERNAME = secretJson.secretValueFromJson('username').unsafeUnwrap();
    const secret_DB_HOST = secretJson.secretValueFromJson('host').unsafeUnwrap();
    
    new ssm.StringParameter(this, 'parameter', {
      parameterName: '/example/EXAMPLE_KEY',
      stringValue: secret_DB_NAME,
    });
  }
}
```

`secretCompleteArn`ã¯ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ãƒãƒã‚³ãƒ³ã§ç¢ºèªã§ãã¾ã™ã€‚

## æ³¨æ„ç‚¹
### ã‚¹ã‚¿ãƒƒã‚¯ã«ã¤ã„ã¦
ä»Šå›ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã«ã‚»ãƒƒãƒˆã™ã‚‹ãŸã‚ã ã‘ã®ã‚¹ã‚¿ãƒƒã‚¯`environments-stack.ts`ã‚’ä½œæˆã—ã¦ã„ã‚‹ã€‚ç†ç”±ã¯ä»¥ä¸‹ã®2ã¤ã€‚
- ä»–ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¹ã‚¿ãƒƒã‚¯ã«å¹²æ¸‰ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã€‚
- ãƒ­ãƒ¼ã‚«ãƒ«ã®`.env`ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ã‚‹ç’°å¢ƒå¤‰æ•°ã‚’ã‚»ãƒƒãƒˆã—ã¦ã„ã‚‹ãŸã‚ã€ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚„CIã«ã‚ˆã‚‹ãƒ‡ãƒ—ãƒ­ã‚¤ã§ã¯å€¤å‚ç…§ã§ããšã‚¨ãƒ©ãƒ¼ã¨ãªã£ã¦ã—ã¾ã†ãŸã‚ã€‚

ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã®å€¤ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã³ã«æ¯å›æ›´æ–°ã—ã¦ã‚‚è‰¯ã„ãŒã€ãã‚‚ãã‚‚è¨­å®šæƒ…å ±ãªã®ã§ã€å¤‰æ›´ãŒãã“ã¾ã§ãªã„ã®ã‚’è€ƒæ…®ã—ã¦ã‚¹ã‚¿ãƒƒã‚¯ã‚’åˆ†é›¢ã—ã¦ã‚‹ã€‚ãŸã ã—ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢ã«å¤‰æ›´ãŒå¿…è¦ãªå ´åˆã«ã‚¤ãƒ³ãƒ•ãƒ©ç®¡ç†è€…ã«é ¼ã‚“ã§è¨­å®šã—ã¦ã‚‚ã‚‰ã†å¿…è¦ãŒã‚ã‚‹ã€‚ï¼ˆãƒãƒã‚³ãƒ³ã§æ“ä½œã§ãã‚Œã°ã‚ã¾ã‚Šé–¢ä¿‚ãªã„ã¨æ€ã„ã¾ã™ï¼‰

### SecretManagerã®å–å¾—æ–¹æ³•ã«ã¤ã„ã¦
ä¸Šè¿°ã—ãŸ"ã‚¹ã‚¿ãƒƒã‚¯ã«ã¤ã„ã¦"ã§ã‚‚è¿°ã¹ãŸã‚ˆã†ã«ã€ã‚¹ã‚¿ãƒƒã‚¯ã‚’åˆ†ã‘ã¦ã„ã‚‹ & å¤‰æ›´ãŒå°‘ãªã„ç‚¹ã‹ã‚‰SecretManagerã‹ã‚‰å€¤ã‚’å–å¾—ã—ã¦ãã‚‹æ™‚ã«ã€ARNã‚’ç›´æ¥æŒ‡å®šã—ã¦ã„ã‚‹ã€‚
ï¼ˆå®Ÿéš›ã«ä»Šå›ã®äº‹ä¾‹ã§ã¯RDSã®æ¥ç¶šæƒ…å ±ã®ã¿ã ã£ãŸã®ã§ä¸€åº¦å–å¾—ã—ã¦ã‚»ãƒƒãƒˆã§ãã‚Œã°ã»ã¼å•é¡ŒãŒãªã„ãŸã‚ï¼‰
`fromSecretNameV2`ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆåã‹ã‚‰å€¤ã‚’å–å¾—ã§ãã‚‹ã¨æ€ã£ãŸãŒã€ã€Œa dash and six random alphanumeric characters at the end of the secret nameã€ã¯å«ã¾ã‚Œãªã„ã€‚
```typescript
const secret = secretsmanager.Secret.fromSecretNameV2(
    this,
    "Secret",
    "MySuperSecret"
);
const secretArn = secret.secretArn;
```
â†‘ã§å–å¾—ã—ãŸ`secretArn`ã¯ **æœ«å°¾ã®ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã‚’å«ã¾ãªã„** ãŸã‚ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚
å…¬å¼â†“
https://docs.aws.amazon.com/cdk/api/v2/docs/aws-cdk-lib.aws_secretsmanager.Secret.html#secretarn

ãªã®ã§ä»Šå›ã¯ãƒãƒã‚³ãƒ³ã‹ã‚‰FullARNã‚’è¦‹ã¤ã‘ã¦ãã‚Œã‚’å…ƒã«å€¤ã‚’å–å¾—ã—ãŸã€‚





